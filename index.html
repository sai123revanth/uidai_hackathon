<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for webkit browsers */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col font-sans antialiased selection:bg-blue-500 selection:text-white">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 flex items-center justify-between shadow-lg z-10">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <div>
                <h1 class="font-bold text-xl tracking-wide">Chatbot</h1>
                <p class="text-xs text-green-400 flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    Online
                </p>
            </div>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth">
        <!-- Welcome Message -->
        <div class="flex justify-start animate-fade-in-up">
            <div class="max-w-[85%] md:max-w-[70%] bg-gray-800 rounded-2xl rounded-tl-none px-6 py-4 shadow-md border border-gray-700">
                <p class="text-gray-200 leading-relaxed">Hello! I'm your AI assistant. I'm connected to the backend and ready to help.</p>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <div class="bg-gray-800 p-4 border-t border-gray-700">
        <form id="chat-form" class="max-w-4xl mx-auto relative flex items-end gap-2">
            <div class="relative flex-1">
                <textarea 
                    id="user-input" 
                    rows="1" 
                    placeholder="Type a message..." 
                    class="w-full bg-gray-900 text-white rounded-xl pl-4 pr-12 py-3 border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none resize-none overflow-hidden max-h-32 transition-all placeholder-gray-500"
                    required
                ></textarea>
            </div>
            <button 
                type="submit" 
                id="send-btn"
                class="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-xl transition-all duration-200 shadow-lg hover:shadow-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </form>
        <div class="text-center mt-2">
             <p class="text-xs text-gray-500">Powered by Llama 3 via Groq</p>
        </div>
    </div>

    <script>
        const form = document.getElementById('chat-form');
        const input = document.getElementById('user-input');
        const chatContainer = document.getElementById('chat-container');
        const sendBtn = document.getElementById('send-btn');

        // Check if running on file protocol
        if (window.location.protocol === 'file:') {
            alert("⚠️ WARNING: You are running this file locally (file://). The chatbot will NOT work.\n\nPlease upload these files to Vercel or run a local server.");
            appendMessage('assistant', "⚠️ SYSTEM ERROR: I am running in local file mode. Please deploy me to Vercel to allow me to speak.", true);
        }

        // Auto-resize textarea
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        // Handle Enter key (Shift+Enter for new line)
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (input.value.trim()) form.dispatchEvent(new Event('submit'));
            }
        });

        function appendMessage(role, text, isError = false) {
            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in-up`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] md:max-w-[70%] px-6 py-4 shadow-md text-gray-200 leading-relaxed ${
                isUser 
                ? 'bg-blue-600 rounded-2xl rounded-tr-none' 
                : isError ? 'bg-red-900/50 border border-red-700 rounded-2xl rounded-tl-none' : 'bg-gray-800 rounded-2xl rounded-tl-none border border-gray-700'
            }`;

            // Handle basic formatting (newlines)
            bubble.innerHTML = text.replace(/\n/g, '<br>');
            
            div.appendChild(bubble);
            chatContainer.appendChild(div);
            
            // Auto scroll
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'flex justify-start animate-fade-in-up';
            div.innerHTML = `
                <div class="bg-gray-800 rounded-2xl rounded-tl-none px-6 py-4 border border-gray-700 flex items-center gap-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return div;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = input.value.trim();
            if (!message) return;

            // UI Updates
            input.value = '';
            input.style.height = 'auto';
            input.disabled = true;
            sendBtn.disabled = true;

            appendMessage('user', message);
            const typingIndicator = showTypingIndicator();

            try {
                // Call the Vercel Serverless Function
                const response = await fetch('/api/chatmodel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                
                // Remove typing indicator
                if(typingIndicator) typingIndicator.remove();

                if (response.ok) {
                    appendMessage('assistant', data.reply);
                } else {
                    // Enhanced error display based on backend response
                    const errorMsg = data.error || "Unknown error occurred";
                    const details = data.details ? `\nDetails: ${data.details}` : "";
                    
                    if(response.status === 404) {
                         appendMessage('assistant', `⚠️ Error 404: The backend file was not found.\nMake sure 'chatmodel.js' is inside the 'api' folder and 'vercel.json' is in the root.`, true);
                    } else {
                         appendMessage('assistant', `Error (${response.status}): ${errorMsg}${details}`, true);
                    }
                    console.error('API Error:', data);
                }

            } catch (error) {
                if(typingIndicator) typingIndicator.remove();
                appendMessage('assistant', "Network Error: Could not reach the backend.\n1. Check if 'vercel.json' exists.\n2. Ensure you are on the Vercel-hosted URL, not local file.", true);
                console.error('Fetch error:', error);
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        });
    </script>
</body>
</html>